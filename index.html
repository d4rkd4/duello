<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Şampiyonlar Düellosu</title>
    <!-- Comfortaa Font -->
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Kodları (Değişiklik Yapılmamıştır) */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comfortaa', cursive;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container, .game-container, .student-selection-container, .admin-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: left;
        }

        #main-screen {
            display: none;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }

        .student-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40%;
        }

        .student-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #555;
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .student-cup {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }

        .game-cup-image {
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }

        .game-cup-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 60%;
            align-items: flex-start;
        }

        .buttons button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            color: white;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buttons button:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .single-player {
            background-color: #A855F7;
        }

        .oyundakiler-button {
            background-color: #10B981;
            margin-top: 15px;
        }

        .oyundakiler-button:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .admin-button {
            background-color: #FF5722;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
            margin: 20px auto 0;
        }

        .admin-button img {
            width: 24px;
            height: 24px;
        }

        .admin-button:hover {
            background-color: #E64A19;
            transform: scale(1.1);
        }

        .game-container, .student-selection-container, .admin-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .table-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .table-section h3 {
            margin-bottom: 10px;
            color: #555;
        }

        .table-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .table-section select, .table-section input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em;
            color: #333;
            background-color: #fff;
        }

        .back-button, .start-game-button, .login-button, .admin-back-button, .duel-start-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 1em;
            margin-top: 20px;
        }

        .back-button, .admin-back-button {
            background-color: #555;
            color: white;
            width: 100%;
            max-width: 200px;
        }

        .back-button:hover, .admin-back-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .start-game-button, .duel-start-button {
            background-color: #4CAF50;
            color: white;
            opacity: 0.5;
            cursor: not-allowed;
            width: 100%;
            max-width: 200px;
        }

        .start-game-button.active, .duel-start-button.active {
            background-color: #28a745;
            opacity: 1;
            cursor: pointer;
        }

        .start-game-button:hover.active, .duel-start-button:hover.active {
            transform: scale(1.05);
        }

        .login-button {
            background-color: #007BFF;
            color: white;
            opacity: 0.5;
            cursor: not-allowed;
            width: 100%;
            max-width: 200px;
        }

        .login-button.active {
            opacity: 1;
            cursor: pointer;
        }

        .login-button:hover.active {
            transform: scale(1.05);
        }

        .admin-student-list {
            list-style-type: none;
            padding: 0;
        }

        .admin-student-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        .admin-student-list li button {
            padding: 8px 12px;
            background-color: #17a2b8;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .admin-student-list li button:hover {
            background-color: #138496;
        }

        @media (max-width: 600px) {
            #main-screen {
                flex-direction: column;
                align-items: center;
            }

            .student-info {
                width: 100%;
                margin-bottom: 20px;
            }

            .buttons {
                width: 100%;
            }

            .student-photo {
                width: 100px;
                height: 100px;
            }

            .student-name {
                font-size: 1.2em;
            }

            .buttons button, .login-button, .admin-button {
                padding: 12px;
                font-size: 0.9em;
            }

            .game-container, .student-selection-container, .admin-container, .single-player-game-container, .duel-selection-container, .duel-game-container {
                padding: 15px 20px;
            }

            .table-section select, .table-section input {
                padding: 8px;
                font-size: 0.9em;
                height: 45px; 
            }

            .back-button, .start-game-button, .login-button, .admin-back-button, .duel-start-button {
                padding: 10px 20px;
                font-size: 0.9em;
            }

            .timer {
                font-size: 1.2em;
            }

            .question-text {
                font-size: 1.2em;
            }

            .option-button {
                font-size: 0.9em;
                padding: 10px 20px;
            }
        }

        .error {
            color: red;
            margin-top: 10px;
            text-align: center;
        }

        .single-player-game-container, .duel-game-container {
            display: none;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .question-number {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #555;
        }

        .progress-container {
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 20px;
            width: 0%;
            background-color: #28a745;
            transition: width 0.3s;
        }

        .timer-container {
            margin-bottom: 20px;
        }

        .timer {
            font-size: 1.5em;
            color: #ff0000;
        }

        .question-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            text-align: center;
            min-height: 150px;
            padding: 20px;
            border: 2px solid #333;
            border-radius: 10px; 
            background-color: #f9f9f9; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            overflow: hidden; 
        }

        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 20px;
            object-fit: contain; 
        }

        .question-text {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            min-height: 60px; 
            word-wrap: break-word; 
            overflow-wrap: break-word; 
            hyphens: auto; 
            max-height: 200px; 
            overflow-y: auto; 
        }

        .options-container {
            display: flex;
            gap: 15px;
            flex-direction: row;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            flex-wrap: wrap; 
        }

        .option-button {
            padding: 15px 25px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, opacity 0.2s;
            flex: 1 1 30%;
            min-width: 150px;
            max-width: 300px;
            font-size: 1em;
            margin: 5px;
            white-space: normal;
            word-wrap: break-word;
        }

        .option-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        .option-button.correct {
            background-color: #28a745 !important;
        }

        .option-button.wrong {
            background-color: #dc3545 !important;
        }

        .option-chosen {
            border: 3px solid #FFD700;
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .option-faded {
            opacity: 0.5;
        }

        .score-container {
            font-size: 1.8em;
            color: #333;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .score-message {
            font-size: 2em;
            font-weight: bold;
            margin-top: 20px;
            animation: glow 1.5s infinite alternate;
            text-align: center;
        }

        .score-message.blue {
            color: #007BFF;
        }

        .score-message.green {
            color: #28a745;
        }

        .score-message.purple {
            color: #6f42c1;
            text-shadow: 0 0 10px #6f42c1, 0 0 20px #6f42c1, 0 0 30px #6f42c1;
            animation: glow-mukemmel 1.5s infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            }
            to {
                text-shadow: 0 0 20px rgba(0, 123, 255, 1);
            }
        }

        @keyframes glow-mukemmel {
            from {
                text-shadow: 0 0 10px rgba(111, 66, 193, 0.5);
            }
            to {
                text-shadow: 0 0 20px rgba(111, 66, 193, 1), 0 0 30px rgba(111, 66, 193, 0.7);
            }
        }

        .final-image {
            width: 200px;
            height: auto;
        }

        .final-back-button {
            background-color: #555;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            font-size: 1em;
        }

        .final-back-button:hover {
            background-color: #333;
            transform: scale(1.05);
        }

        .davet-et-button {
            background-color: #f59e0b;
            border: none;
            border-radius: 5px;
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .davet-et-button:hover {
            background-color: #d97706;
        }

        /* Oyundakiler Modal */
        .players-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.4);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:9999999;
        }

        .players-content {
            background:#fff;
            padding:20px;
            border-radius:10px;
            width:90%;
            max-width:400px;
            box-shadow:0 0 10px rgba(0,0,0,0.2);
            display:flex;
            flex-direction:column;
            gap:15px;
        }

        .players-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .players-header h3 {
            margin:0;
            font-size:1.5em;
            color:#333;
        }

        .players-close {
            background: none;
            border:none;
            font-size:1.2em;
            cursor:pointer;
            color:#333;
        }

        .players-list {
            list-style:none;
            padding:0;
            margin:0;
            display:flex;
            flex-direction:column;
            gap:10px;
        }

        .players-list li {
            display:flex;
            align-items:center;
            gap:10px;
            background:#f0f0f0;
            padding:10px;
            border-radius:5px;
            justify-content: space-between;
        }

        .players-list img {
            width:40px;
            height:40px;
            border-radius:50%;
            object-fit:cover;
            border:2px solid #333;
        }

        .players-list .player-name {
            font-size:1em;
            color:#333;
            flex:1;
        }

        /* Alert, Prompt, Invitation Modals */
        .alert-overlay, .prompt-overlay, .invitation-overlay {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items:center;
            justify-content:center;
            z-index:99999999;
        }

        .alert-content, .prompt-content, .invitation-content {
            background:#fff;
            padding:20px;
            border-radius:10px;
            width:90%;
            max-width:300px;
            box-shadow:0 0 10px rgba(0,0,0,0.2);
            display:flex;
            flex-direction:column;
            gap:15px;
            text-align: center;
        }

        .alert-message, .prompt-message, .invitation-message {
            font-size:1em;
            color:#333;
        }

        .alert-ok-button, .prompt-ok-button, .prompt-cancel-button, .invitation-accept-button, .invitation-decline-button {
            background-color: #007BFF;
            color:white;
            border:none;
            border-radius:5px;
            padding:10px 20px;
            cursor:pointer;
        }

        .alert-ok-button:hover, .prompt-ok-button:hover, .prompt-cancel-button:hover, .invitation-accept-button:hover, .invitation-decline-button:hover {
            background-color: #0056b3;
        }

        .prompt-input {
            width:100%;
            padding:10px;
            border:1px solid #ccc;
            border-radius:5px;
            font-size:1em;
        }

        .prompt-buttons, .invitation-buttons {
            display:flex;
            justify-content:space-between;
        }

        .prompt-cancel-button, .invitation-decline-button {
            background-color:#dc3545;
        }

        .prompt-cancel-button:hover, .invitation-decline-button:hover {
            background-color:#c82333;
        }

        .duel-selection-container {
            display: none;
            position: relative;
            overflow:hidden;
            padding-bottom: 120px;
            text-align:center;
        }

        /* İki oyuncuyu eşit orantıda yerleştirmek için space-evenly kullandık */
        .duel-bottom-info {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-evenly;
        }

        .duel-player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width:120px; 
            overflow:hidden;
        }

        .duel-player-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #555;
            margin-bottom: 5px;
        }

        .duel-player-name {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            max-width:100%;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            text-align:center;
            display:block;
        }

        .duel-controls {
            display:flex;
            flex-direction:column;
            gap:10px;
            align-items:center;
            justify-content:center;
            margin-top:20px;
        }

        .duel-start-button {
            display:inline-block;
            margin:0 auto;
        }

        .duel-game-container .players-info-row {
            display: flex;
            width: 100%;
            max-width: 800px;
            justify-content: space-between;
            align-items: center;
        }

        .duel-player-score {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            overflow:hidden;
            position: relative;
        }

        .duel-player-score img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #555;
            object-fit: cover;
            margin-bottom: 5px;
        }

        .duel-player-score .duel-player-name {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            text-overflow: ellipsis;
            overflow:hidden;
            white-space:nowrap;
            max-width:100px;
        }

        .duel-player-correct-count {
            font-size: 1.2em;
            margin-top: 5px;
            color: #28a745;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .winner-message {
            font-size: 2em;
            font-weight: bold;
            color: #6f42c1;
            text-align:center;
            animation: glow-mukemmel 1.5s infinite alternate;
            margin-bottom:20px;
        }

        .score-flash {
            animation: score-flash 0.8s ease;
        }

        @keyframes score-flash {
            0% {transform: scale(1) rotate(0deg); color:#28a745;}
            30% {transform: scale(1.5) rotate(10deg); color:#28a745;}
            60% {transform: scale(1.3) rotate(-10deg); color:#28a745;}
            100% {transform: scale(1) rotate(0deg); color:#28a745;}
        }

        .score-plus-one {
            /* Eski efekt kaldırıldı */
        }

        /* Yeni +1 Efekti */
        .animated-plus-one {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 7em;
            color: #28a745;
            pointer-events: none;
            z-index: 1000;
            opacity: 1;
        }

        @keyframes plus-one-move {
            0% {
                opacity:1;
                transform: translate(-50%, -50%) translate(0px, 0px) scale(1);
            }
            100% {
                opacity:0;
                transform: translate(-50%, -50%) translate(300px, -300px) scale(0.5);
            }
        }

        /* "Oyunda" Butonu İçin Ek Stil */
        .oyunda-button {
            background-color: #f59e0b; /* Turuncu renk */
            border: none;
            border-radius: 5px;
            color: white;
            padding: 5px 10px;
            font-size: 0.9em;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .oyunda-button:hover {
            background-color: #d97706;
            opacity: 0.7; /* Hover etkisini kaldırmak için */
            transform: none;
        }
    </style>
</head>
<body>
    <!-- Oyundakiler Modal -->
    <div class="players-overlay" id="playersOverlay">
        <div class="players-content">
            <div class="players-header">
                <h3>Oyundakiler</h3>
                <button class="players-close" id="playersCloseButton">X</button>
            </div>
            <ul class="players-list" id="playersList"></ul>
        </div>
    </div>

    <!-- Öğrenci Seçimi Ekranı -->
    <div class="container student-selection-container" id="student-selection-screen">
        <h2>Öğrenci Seçimi</h2>
        <div class="table-section">
            <h3>Öğrenci Seçme</h3>
            <label for="selection-class-select">Sınıfı Seç:</label>
            <select id="selection-class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="selection-name-select">Öğrenciyi Seç:</label>
            <select id="selection-name-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="student-password-input">Şifre Giriniz:</label>
            <input type="password" id="student-password-input" placeholder="Şifre" disabled>
        </div>
        <button class="login-button" id="login-button" disabled>Giriş</button>
        <button class="admin-button" id="admin-button">
            <img src="https://cdn.pixabay.com/photo/2019/10/06/11/40/lock-4529981_1280.png" alt="Admin">
        </button>
        <div class="error" id="student-selection-error"></div>
    </div>

    <!-- Ana Ekran -->
    <div class="container" id="main-screen" style="display: none;">
        <div class="student-info">
            <img src="" alt="Öğrenci Fotoğrafı" class="student-photo" id="student-photo" style="display: none;">
            <div class="student-name" id="student-name"></div>
            <div class="student-cup">
                <img src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExMnk0M3A2MWR2aTJxenhoMjJ2dmRybXFzNjRlam9oNGlpM3p2eW0zayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/wX7I4l8SfFyG8rqhsd/giphy.webp" alt="Game Cup" class="game-cup-image">
                <span class="game-cup-score" id="game-cup-score">0</span>
            </div>
        </div>
        <div class="buttons">
            <button class="single-player">Tek Kişilik Oyun</button>
            <button class="oyundakiler-button" id="oyundakiler-button">Oyundakiler</button>
        </div>
    </div>

    <!-- Tek Kişilik Oyun Ekranı -->
    <div class="game-container" id="single-player-screen">
        <h2>Tek Kişilik Oyun</h2>
        <div class="table-section">
            <h3>Konu Belirleme</h3>
            <label for="class-select">Sınıf Seç:</label>
            <select id="class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="subject-select">Ders Seç:</label>
            <select id="subject-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="topic-select">Konu Seç:</label>
            <select id="topic-select">
                <option value="">Seçiniz</option>
            </select>
        </div>
        <button class="start-game-button" id="start-game-button" disabled>Oyuna Başla</button>
        <button class="back-button">Geri Dön</button>
    </div>

    <!-- Admin Ekranı -->
    <div class="container admin-container" id="admin-screen">
        <h2>Admin Paneli</h2>
        <div class="table-section">
            <h3>Sınıf Seçimi ve PIN Doğrulama</h3>
            <label for="admin-class-select">Sınıf Seç:</label>
            <select id="admin-class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="admin-pin-input">Sınıf PIN'i Gir:</label>
            <input type="password" id="admin-pin-input" placeholder="PIN">

            <button class="login-button" id="admin-login-button" disabled>PIN Doğrula</button>
        </div>
        <div class="table-section" id="admin-student-section" style="display: none;">
            <h3>Öğrenciler</h3>
            <ul class="admin-student-list" id="admin-student-list"></ul>
        </div>
        <button class="admin-back-button">Geri Dön</button>
    </div>

    <!-- Tek Kişilik Oyun Sorular Ekranı -->
    <div class="single-player-game-container" id="single-player-game-screen">
        <div class="progress-container">
            <div class="question-number" id="question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="question-image" style="display: none;">
            <div class="question-text" id="question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="options-container"></div>
        <div class="score-container" id="score-container">
            <span id="score"></span>
            <div class="score-message" id="score-message"></div>
            <img id="score-image" class="final-image" style="display:none;" alt="Sonuç Resmi">
            <button class="final-back-button" id="final-back-button">Geri Dön</button>
        </div>
    </div>

    <!-- Düello Seçim Ekranı -->
    <div class="duel-selection-container" id="duel-selection-screen">
        <h2>Ortak Seçim Ekranı</h2>
        <div class="table-section">
            <h3>Konu Belirleme</h3>
            <label for="duel-class-select">Sınıf Seç:</label>
            <select id="duel-class-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="duel-subject-select">Ders Seç:</label>
            <select id="duel-subject-select">
                <option value="">Seçiniz</option>
            </select>

            <label for="duel-topic-select">Konu Seç:</label>
            <select id="duel-topic-select">
                <option value="">Seçiniz</option>
            </select>
        </div>
        <div class="duel-controls">
            <button class="duel-start-button" id="duel-start-button" disabled>Düelloya Başla</button>
            <button class="back-button" id="duel-back-button">Geri Dön</button>
        </div>

        <div class="duel-bottom-info">
            <div class="duel-player-info" id="duel-inviter-info">
                <img src="" class="duel-player-photo" id="duel-inviter-photo">
                <div class="duel-player-name" id="duel-inviter-name"></div>
            </div>
            <div class="duel-player-info" id="duel-invited-info">
                <img src="" class="duel-player-photo" id="duel-invited-photo">
                <div class="duel-player-name" id="duel-invited-name"></div>
            </div>
        </div>
    </div>

    <!-- Düello Oyun Ekranı -->
    <div class="duel-game-container" id="duel-game-screen">
        <div class="progress-container">
            <div class="question-number" id="duel-question-number">Soru 1/10</div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="duel-progress-bar-inner"></div>
            </div>
        </div>
        <div class="timer-container">
            <div class="timer" id="duel-timer">45</div>
        </div>
        <div class="question-container">
            <img src="" alt="Soru Resmi" class="question-image" id="duel-question-image" style="display: none;">
            <div class="question-text" id="duel-question-text">Soru metni burada olacak.</div>
        </div>
        <div class="options-container" id="duel-options-container"></div>

        <div class="players-info-row">
            <div class="duel-player-score" id="duel-player-inviter-score">
                <img id="duel-player-inviter-photo" src="">
                <div class="duel-player-name" id="duel-player-inviter-name"></div>
                <div class="duel-player-correct-count" id="inviter-correct-count">0</div>
            </div>
            <div class="duel-player-score" id="duel-player-invited-score">
                <img id="duel-player-invited-photo" src="">
                <div class="duel-player-name" id="duel-player-invited-name"></div>
                <div class="duel-player-correct-count" id="invited-correct-count">0</div>
            </div>
        </div>

        <div class="score-container" id="duel-final-container">
            <div class="winner-message" id="winner-message"></div>
            <button class="final-back-button" id="duel-final-back-button">Çık</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="alert-overlay" id="alertOverlay">
        <div class="alert-content">
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-ok-button" id="alertOkButton">Tamam</button>
        </div>
    </div>

    <!-- Prompt Modal -->
    <div class="prompt-overlay" id="promptOverlay">
        <div class="prompt-content">
            <div class="prompt-message" id="promptMessage"></div>
            <input type="text" class="prompt-input" id="promptInput">
            <div class="prompt-buttons">
                <button class="prompt-cancel-button" id="promptCancelButton">İptal</button>
                <button class="prompt-ok-button" id="promptOkButton">Tamam</button>
            </div>
        </div>
    </div>

    <!-- Davet Modalı -->
    <div class="invitation-overlay" id="invitationOverlay">
        <div class="invitation-content">
            <div class="invitation-message" id="invitationMessage"></div>
            <div class="invitation-buttons">
                <button class="invitation-decline-button" id="invitationDeclineButton">Reddet</button>
                <button class="invitation-accept-button" id="invitationAcceptButton">Kabul Et</button>
            </div>
        </div>
    </div>

    <!-- Arka Plan Müziği için Audio Elementi -->
    <audio id="duelBackgroundMusic" src="https://github.com/d4rkd4/audio-assets/raw/refs/heads/main/OYUN%202%20ARKA%20PLAN%20M%C3%9CZ%C4%B0%C4%9E%C4%B0.mp3" preload="auto"></audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script>
        // JavaScript Kodları (Güncellenmiş)

        document.getElementById('duel-final-back-button').addEventListener('click', async () => {
            if (currentDuelRef) {
                try {
                    await currentDuelRef.remove();
                    currentDuelRef = null;
                    isInviter = false;
                    duelGameStarted = false;
                    window.location.reload();
                } catch (error) {
                    console.error("Düello referansı kaldırılırken hata:", error);
                    showAlert('Düello referansı kaldırılırken hata oluştu.');
                }
            } else {
                window.location.reload();
            }
        });

        window.addEventListener('beforeunload', () => {
            if (selectedStudent && selectedStudent.studentId) {
                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(false)
                .then(() => console.log("inDuel set to false"))
                .catch(err => console.error("Failed to update inDuel status:", err));
            }
        });

        // Lütfen kendi firebaseConfig değerlerinizi girin
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_DOMAIN",
            databaseURL: "https://sampiyonlar-ligi-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Kodu uzun olduğu için açıklamalar önceki mesajlarda yapıldı.
        // Bu kod son halidir ve tüm istenen değişiklikleri içerir.
        // İstediğiniz tüm özellikler: orantılı ortak seçim ekranı, düello bitince reset, metinler tam gösteriliyor, vs. mevcut.

        let classNameMap = {};

        const playersOverlay = document.getElementById('playersOverlay');
        const playersCloseButton = document.getElementById('playersCloseButton');
        const playersList = document.getElementById('playersList');
        const oyundakilerButton = document.getElementById('oyundakiler-button');
        const invitationOverlay = document.getElementById('invitationOverlay');
        const invitationMessage = document.getElementById('invitationMessage');

        playersCloseButton.addEventListener('click', () => {
            playersOverlay.style.display = 'none';
        });

        let loggedinPlayerRef = null;
        let selectedStudent = {
            classId: '',
            studentId: '',
            studentName: ''
        };

        const studentPhoto = document.getElementById('student-photo');
        const studentName = document.getElementById('student-name');

        async function addLoggedInPlayer(student) {
            const newRef = database.ref('loggedinPlayers').push();
            await newRef.set({
                name: student.studentName,
                photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : "",
                classId: student.classId,
                studentId: student.studentId
            });
            newRef.onDisconnect().remove();
            loggedinPlayerRef = newRef;
        }

        async function showLoggedInPlayers() {
            playersList.innerHTML = '';
            const snapshot = await database.ref('loggedinPlayers').once('value');
            let playersArr = [];

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const player = child.val();
                    playersArr.push({ ...player, key: child.key });
                });

                // Sınıf adına göre sırala (aynı sınıftakiler önce)
                const sameClassPlayers = playersArr.filter(p => p.classId === selectedStudent.classId && p.studentId !== selectedStudent.studentId);
                const otherClassPlayers = playersArr.filter(p => p.classId !== selectedStudent.classId);
                playersArr = [...sameClassPlayers, ...otherClassPlayers];

                for (const player of playersArr) {
                    let photoURL = "https://via.placeholder.com/40";
                    try {
                        const photoSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/photo`).once('value');
                        if (photoSnapshot.exists()) {
                            photoURL = photoSnapshot.val();
                        }
                    } catch (e) {
                        console.error('Fotoğraf alınamadı:', e);
                    }

                    // "Oyunda" butonu için inDuel kontrolü
                    let inDuel = false;
                    try {
                        const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                        if (inDuelSnapshot.exists()) {
                            inDuel = inDuelSnapshot.val();
                        }
                    } catch (e) {
                        console.error('inDuel durumu alınamadı:', e);
                    }

                    const li = document.createElement('li');
                    const img = document.createElement('img');
                    img.src = photoURL;

                    const span = document.createElement('span');
                    span.className = 'player-name';
                    let clsName = classNameMap[player.classId] ? classNameMap[player.classId] : player.classId;
                    span.textContent = `${player.name} / (${clsName})`;

                    if (inDuel) {
                        // "Oyunda" Butonu
                        const oyundaButton = document.createElement('button');
                        oyundaButton.textContent = 'Oyunda';
                        oyundaButton.className = 'oyunda-button'; // Yeni sınıf kullanıldı
                        oyundaButton.disabled = true; // Tıklanamaz
                        li.appendChild(img);
                        li.appendChild(span);
                        li.appendChild(oyundaButton);
                    } else {
                        // "Davet Et" Butonu
                        const davetButton = document.createElement('button');
                        davetButton.textContent = 'Davet Et';
                        davetButton.className = 'davet-et-button';
                        davetButton.addEventListener('click', () => {
                            sendInvitation(player);
                        });
                        li.appendChild(img);
                        li.appendChild(span);
                        li.appendChild(davetButton);
                    }

                    playersList.appendChild(li);
                }
            } else {
                const li = document.createElement('li');
                li.textContent = "Şu an oyunda kimse yok.";
                playersList.appendChild(li);
            }
            playersOverlay.style.display = 'flex';
        }
        oyundakilerButton.addEventListener('click', showLoggedInPlayers);

        const studentSelectionScreen = document.getElementById('student-selection-screen');
        const mainScreen = document.getElementById('main-screen');
        const singlePlayerScreen = document.getElementById('single-player-screen');
        const adminScreen = document.getElementById('admin-screen');
        const singlePlayerGameScreen = document.getElementById('single-player-game-screen');
        const duelSelectionScreen = document.getElementById('duel-selection-screen');
        const duelGameScreen = document.getElementById('duel-game-screen');

        const loginButton = document.getElementById('login-button');
        const adminButton = document.getElementById('admin-button');
        const singlePlayerButton = document.querySelector('.single-player');
        const backButtons = document.querySelectorAll('.back-button');
        const adminBackButton = document.querySelector('.admin-back-button');
        const startGameButton = document.getElementById('start-game-button');
        const finalBackButton = document.getElementById('final-back-button');

        const adminClassSelect = document.getElementById('admin-class-select');
        const adminPinInput = document.getElementById('admin-pin-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminStudentSection = document.getElementById('admin-student-section');
        const adminStudentList = document.getElementById('admin-student-list');

        const selectionClassSelect = document.getElementById('selection-class-select');
        const selectionNameSelect = document.getElementById('selection-name-select');

        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const topicSelect = document.getElementById('topic-select');

        const studentPasswordInput = document.getElementById('student-password-input');
        const studentSelectionError = document.getElementById('student-selection-error');

        let gameQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const questionNumber = document.getElementById('question-number');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const scoreContainer = document.getElementById('score-container');
        const scoreDisplay = document.getElementById('score');
        const scoreMessage = document.getElementById('score-message');
        const scoreImage = document.getElementById('score-image');
        const timerElement = document.getElementById('timer');

        const duelClassSelect = document.getElementById('duel-class-select');
        const duelSubjectSelect = document.getElementById('duel-subject-select');
        const duelTopicSelect = document.getElementById('duel-topic-select');
        const duelStartButton = document.getElementById('duel-start-button');
        const duelBackButton = document.getElementById('duel-back-button');

        const duelInviterPhoto = document.getElementById('duel-inviter-photo');
        const duelInviterName = document.getElementById('duel-inviter-name');
        const duelInvitedPhoto = document.getElementById('duel-invited-photo');
        const duelInvitedName = document.getElementById('duel-invited-name');

        const duelQuestionNumber = document.getElementById('duel-question-number');
        const duelProgressBarInner = document.getElementById('duel-progress-bar-inner');
        const duelTimerElement = document.getElementById('duel-timer');
        const duelQuestionImage = document.getElementById('duel-question-image');
        const duelQuestionText = document.getElementById('duel-question-text');
        const duelOptionsContainer = document.getElementById('duel-options-container');

        const inviterCorrectCountEl = document.getElementById('inviter-correct-count');
        const invitedCorrectCountEl = document.getElementById('invited-correct-count');

        const duelFinalContainer = document.getElementById('duel-final-container');
        const winnerMessage = document.getElementById('winner-message');
        const duelFinalBackButton = document.getElementById('duel-final-back-button');

        // Arka plan müziği elementini seçiyoruz
        const duelMusic = document.getElementById('duelBackgroundMusic');

        let timer;
        let timeLeft = 45;

        let duelTimer;
        let duelTimeLeft = 45;

        let currentDuelRef = null;
        let isInviter = false;
        let currentInvitation = null;

        let duelQuestions = [];
        let duelCurrentQuestionIndex = 0;
        let duelInviterScore = 0;
        let duelInvitedScore = 0;
        let duelClassId = "";
        let duelSubjectId = "";
        let duelTopicId = "";
        let duelQuestionLocked = false;
        let duelGameStarted = false;

        window.onload = () => {
            studentSelectionScreen.style.display = 'flex';
            fetchClassesForSelection();
            fetchAdminClasses();
            fetchChampionData();
        };

        async function fetchAllClasses() {
            const snapshot = await database.ref('classes').once('value');
            if (snapshot.exists()) {
                snapshot.forEach(childSnapshot => {
                    const classId = childSnapshot.key;
                    const className = childSnapshot.val().name;
                    classNameMap[classId] = className;
                });
            }
        }
        fetchAllClasses();

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("Kullanıcı oturum açtı:", user);
            } else {
                console.log("Kullanıcı oturum açmadı.");
            }
        });

        loginButton.addEventListener('click', async () => {
            selectedStudent.classId = selectionClassSelect.value;
            selectedStudent.studentId = selectionNameSelect.value;
            selectedStudent.studentName = selectionNameSelect.options[selectionNameSelect.selectedIndex].text;
            const enteredPassword = studentPasswordInput.value.trim();

            if (selectedStudent.classId && selectedStudent.studentId) {
                if (enteredPassword === "") {
                    studentSelectionError.textContent = 'Lütfen şifrenizi giriniz.';
                    return;
                }

                database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/password`).once('value').then(async snapshot => {
                    if (snapshot.exists()) {
                        const correctPassword = snapshot.val();
                        if (enteredPassword === correctPassword) {
                            studentSelectionScreen.style.display = 'none';
                            mainScreen.style.display = 'flex';
                            studentSelectionError.textContent = '';
                            studentPasswordInput.value = '';

                            database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/photo`).once('value').then(photoSnapshot => {
                                if (photoSnapshot.exists()) {
                                    const photoURL = photoSnapshot.val();
                                    studentPhoto.src = photoURL;
                                    studentPhoto.style.display = 'block';
                                } else {
                                    studentPhoto.style.display = 'none';
                                }
                            }).catch(error => {
                                console.error("Fotoğraf çekilirken hata:", error);
                                studentPhoto.style.display = 'none';
                            });

                            studentName.textContent = selectedStudent.studentName;
                            await addLoggedInPlayer(selectedStudent);
                            startInvitationListener(selectedStudent.studentId);
                            fetchAndDisplayGameCup(); // gameCup puanını çek ve göster
                        } else {
                            studentSelectionError.textContent = 'Yanlış şifre. Lütfen tekrar deneyiniz.';
                        }
                    } else {
                        studentSelectionError.textContent = 'Bu öğrenci için şifre tanımlanmamış.';
                    }
                }).catch(error => {
                    console.error("Şifre kontrol hata:", error);
                    studentSelectionError.textContent = 'Şifre kontrol edilirken hata oluştu.';
                });
            }
        });

        adminButton.addEventListener('click', () => {
            studentSelectionScreen.style.display = 'none';
            adminScreen.style.display = 'flex';
        });

        backButtons.forEach(backButton => {
            backButton.addEventListener('click', () => {
                const currentScreen = backButton.parentElement;
                if(currentScreen.id === 'duel-selection-screen' && currentDuelRef) {
                    // Düello referansını kaldır ve sayfayı yenile
                    currentDuelRef.remove().then(() => {
                        currentDuelRef = null;
                        isInviter = false;
                        duelGameStarted = false;
                        // Sayfayı yenile
                        window.location.reload();
                    }).catch(error => {
                        console.error("Düello referansı kaldırılırken hata:", error);
                        showAlert('Düello referansı kaldırılırken hata oluştu.');
                    });
                } else {
                    currentScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    resetGameScreens();
                }
            });
        });

        adminBackButton.addEventListener('click', () => {
            adminScreen.style.display = 'none';
            studentSelectionScreen.style.display = 'flex';
            resetAdminScreens();
        });

        singlePlayerButton.addEventListener('click', () => {
            mainScreen.style.display = 'none';
            singlePlayerScreen.style.display = 'flex';
        });

        startGameButton.addEventListener('click', () => {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedTopic = topicSelect.value;

            if (selectedClass && selectedSubject && selectedTopic) {
                fetchQuestions(selectedClass, selectedSubject, selectedTopic);
            } else {
                showAlert('Lütfen tüm alanları doldurunuz.');
            }
        });

        adminLoginButton.addEventListener('click', () => {
            const selectedClass = adminClassSelect.value;
            const enteredPin = adminPinInput.value;

            if (selectedClass === "" || enteredPin === "") {
                showAlert('Lütfen sınıf ve PIN girin.');
                return;
            }

            database.ref(`classes/${selectedClass}/pin`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const correctPin = snapshot.val();
                    if (enteredPin === correctPin) {
                        fetchAdminStudents(selectedClass);
                        adminStudentSection.style.display = 'block';
                        studentSelectionError.textContent = '';
                    } else {
                        showAlert('Yanlış PIN.');
                    }
                } else {
                    showAlert('Bu sınıf için PIN yok.');
                }
            }).catch(error => {
                console.error("PIN kontrol hata:", error);
                showAlert('PIN kontrol edilirken hata oluştu.');
            });
        });

        async function handlePasswordUpdate(classId, studentId) {
            const newPassword = await showPrompt('Yeni şifreyi giriniz:');
            if (newPassword !== null) {
                if (newPassword.trim() !== "") {
                    database.ref(`classes/${classId}/students/${studentId}/password`).set(newPassword.trim()).then(() => {
                        showAlert('Şifre oluşturuldu/güncellendi.');
                    }).catch(error => {
                        console.error("Şifre güncellenirken hata:", error);
                        showAlert('Şifre güncellerken hata oluştu.');
                    });
                } else {
                    showAlert('Şifre boş olamaz.');
                }
            }
        }

        function fetchAdminStudents(classId) {
            adminStudentList.innerHTML = '';
            database.ref(`classes/${classId}/students`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const studentId = childSnapshot.key;
                        const studentName = childSnapshot.val().name;

                        const listItem = document.createElement('li');
                        listItem.textContent = studentName;

                        const passwordButton = document.createElement('button');
                        passwordButton.textContent = 'Şifre Oluştur/Güncelle';
                        passwordButton.addEventListener('click', () => {
                            handlePasswordUpdate(classId, studentId);
                        });

                        listItem.appendChild(passwordButton);
                        adminStudentList.appendChild(listItem);
                    });
                } else {
                    adminStudentList.innerHTML = '<li>Bu sınıfa ait öğrenci yok.</li>';
                }
            }).catch(error => {
                console.error("Öğrenciler çekilirken hata:", error);
                showAlert('Öğrenciler çekilirken hata oluştu.');
            });
        }

        function fetchStudents(classId, studentNameSelectElement) {
            studentNameSelectElement.innerHTML = '<option value="">Seçiniz</option>';
            if (classId === "") return;

            database.ref(`classes/${classId}/students`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const studentId = childSnapshot.key;
                        const studentName = childSnapshot.val().name;

                        const option = document.createElement('option');
                        option.value = studentId;
                        option.textContent = studentName;
                        studentNameSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu sınıfa ait öğrenci yok";
                    studentNameSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Öğrenci çekme hata:", error);
            });
        }

        function fetchChampionData() {
            database.ref('championData/headings').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const classId = childSnapshot.key;
                        const className = childSnapshot.val().name ? childSnapshot.val().name : 'No name';
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = className;
                        classSelect.appendChild(option);
                    });
                } else {
                    console.warn("championData/headings boş.");
                }
            }).catch(error => {
                console.error("Sınıf bilgileri hata:", error);
            });
        }

        function fetchLessons(classId, subjectSelectElement) {
            subjectSelectElement.innerHTML = '<option value="">Seçiniz</option>';
            if (subjectSelectElement.id === 'duel-subject-select') {
                duelTopicSelect.innerHTML = '<option value="">Seçiniz</option>';
            } else {
                topicSelect.innerHTML = '<option value="">Seçiniz</option>';
            }

            if (classId === "") return;

            database.ref(`championData/headings/${classId}/lessons`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const lessonId = childSnapshot.key;
                        const lessonName = childSnapshot.val().name ? childSnapshot.val().name : 'No name';

                        const option = document.createElement('option');
                        option.value = lessonId;
                        option.textContent = lessonName;
                        subjectSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu sınıfa ait ders yok";
                    subjectSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Ders bilgileri hata:", error);
            });
        }

        function fetchTopics(classId, lessonId, topicSelectElement) {
            topicSelectElement.innerHTML = '<option value="">Seçiniz</option>';

            if (lessonId === "") return;

            database.ref(`championData/headings/${classId}/lessons/${lessonId}/topics`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const topicId = childSnapshot.key;
                        const topicName = childSnapshot.val().name ? childSnapshot.val().name : 'No name';

                        const option = document.createElement('option');
                        option.value = topicId;
                        option.textContent = topicName;
                        topicSelectElement.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Bu derse ait konu yok";
                    topicSelectElement.appendChild(option);
                }
            }).catch(error => {
                console.error("Konu bilgileri hata:", error);
            });
        }

        const singlePlayerSelects = singlePlayerScreen.querySelectorAll('select');
        singlePlayerSelects.forEach(select => {
            select.addEventListener('change', checkSinglePlayerSelections);
        });

        adminPinInput.addEventListener('input', () => {
            if (adminClassSelect.value !== "" && adminPinInput.value !== "") {
                adminLoginButton.classList.add('active');
                adminLoginButton.disabled = false;
            } else {
                adminLoginButton.classList.remove('active');
                adminLoginButton.disabled = true;
            }
        });

        function checkSinglePlayerSelections() {
            let allSelected = true;
            singlePlayerSelects.forEach(select => {
                if (select.value === "") {
                    allSelected = false;
                }
            });

            if (allSelected) {
                startGameButton.classList.add('active');
                startGameButton.disabled = false;
            } else {
                startGameButton.classList.remove('active');
                startGameButton.disabled = true;
            }
        }

        selectionClassSelect.addEventListener('change', () => {
            const selectedClass = selectionClassSelect.value;
            if (selectedClass === "") {
                selectionNameSelect.innerHTML = '<option value="">Seçiniz</option>';
                checkLoginButtonState();
                return;
            }
            fetchStudents(selectedClass, selectionNameSelect);
            checkLoginButtonState();
        });

        selectionNameSelect.addEventListener('change', () => {
            checkLoginButtonState();
        });

        function checkLoginButtonState() {
            if (selectionClassSelect.value !== "" && selectionNameSelect.value !== "") {
                loginButton.classList.add('active');
                loginButton.disabled = false;
                studentPasswordInput.disabled = false;
            } else {
                loginButton.classList.remove('active');
                loginButton.disabled = true;
                studentPasswordInput.disabled = true;
                studentPasswordInput.value = '';
            }
        }

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            fetchLessons(selectedClass, subjectSelect);
        });

        subjectSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            const selectedLesson = subjectSelect.value;
            fetchTopics(selectedClass, selectedLesson, topicSelect);
        });

        function resetGameScreens() {
            // Tek Kişilik Oyun Ekranı
            singlePlayerSelects.forEach(select => {
                select.value = "";
            });
            startGameButton.classList.remove('active');
            startGameButton.disabled = true;

            scoreContainer.style.display = 'none';
            scoreMessage.textContent = '';
            scoreMessage.className = 'score-message';
            scoreImage.style.display = 'none';

            // Düello Oyun Ekranı
            duelQuestionNumber.textContent = 'Soru 1/10';
            duelProgressBarInner.style.width = '0%';
            duelTimerElement.textContent = '45';
            duelTimerElement.style.color = '#ff0000';
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";
        }

        function resetAdminScreens() {
            adminClassSelect.value = "";
            adminPinInput.value = "";
            adminLoginButton.disabled = true;
            adminLoginButton.classList.remove('active');
            adminStudentSection.style.display = 'none';
            adminStudentList.innerHTML = '';
            studentSelectionError.textContent = '';
        }

        function fetchQuestions(classId, subjectId, topicId) {
            const questionsRef = database.ref(`championData/headings/${classId}/lessons/${subjectId}/topics/${topicId}/questions`);
            questionsRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const allQuestions = [];
                    snapshot.forEach(childSnapshot => {
                        const questionData = childSnapshot.val();
                        allQuestions.push(questionData);
                    });

                    if (allQuestions.length < 10) {
                        showAlert('Bu konuya ait yeterli soru yok.');
                        return;
                    }

                    gameQuestions = shuffleArray(allQuestions).slice(0, 10);
                    currentQuestionIndex = 0;
                    score = 0;

                    singlePlayerScreen.style.display = 'none';
                    singlePlayerGameScreen.style.display = 'flex';
                    scoreContainer.style.display = 'none';
                    displayCurrentQuestion();
                } else {
                    showAlert('Bu konuya ait soru bulunamadı.');
                }
            }).catch(error => {
                console.error("Sorular çekme hata:", error);
                showAlert('Sorular çekilirken hata oluştu.');
            });
        }

        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function displayCurrentQuestion() {
            const currentQuestion = gameQuestions[currentQuestionIndex];
            questionNumber.textContent = `Soru ${currentQuestionIndex + 1}/10`;
            const progressPercentage = ((currentQuestionIndex) / 10) * 100;
            progressBarInner.style.width = `${progressPercentage}%`;

            if (currentQuestion.question.startsWith('http')) {
                questionImage.src = currentQuestion.question;
                questionImage.style.display = 'block';
                questionText.textContent = '';
            } else {
                questionImage.style.display = 'none';
                questionText.textContent = currentQuestion.question;
            }

            const options = [
                { text: currentQuestion.correct, correct: true },
                { text: currentQuestion.wrong1, correct: false },
                { text: currentQuestion.wrong2, correct: false }
            ];
            const shuffledOptions = shuffleArray(options);

            optionsContainer.innerHTML = '';
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option.text;
                button.dataset.correct = option.correct;
                button.addEventListener('click', selectOption);
                optionsContainer.appendChild(button);
            });

            resetTimer();
            startTimer();
        }

        function selectOption(e) {
            const selectedButton = e.target;
            const isCorrect = selectedButton.dataset.correct === 'true';

            document.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
                if (button !== selectedButton) {
                    button.classList.add('option-faded');
                } else {
                    button.classList.add('option-chosen');
                }
            });

            if (isCorrect) {
                selectedButton.classList.add('correct');
                score++;
            } else {
                selectedButton.classList.add('wrong');
                document.querySelectorAll('.option-button').forEach(button => {
                    if (button.dataset.correct === 'true') {
                        button.classList.add('correct');
                    }
                });
            }

            clearInterval(timer);

            setTimeout(() => {
                proceedToNextQuestion();
            }, 1000);
        }

        function proceedToNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < 10) {
                displayCurrentQuestion();
            } else {
                endGame();
            }
        }

        function endGame() {
            questionNumber.style.display = 'none';
            document.querySelector('.progress-container').style.display = 'none';
            document.querySelector('.timer-container').style.display = 'none';
            document.querySelector('.question-container').style.display = 'none';
            optionsContainer.style.display = 'none';

            scoreContainer.style.display = 'flex';
            scoreDisplay.textContent = `Doğru Sayısı: ${score}/10`;

            let message = '';
            let messageClass = '';
            let imageUrl = '';
            scoreMessage.style.display = 'block';

            if (score === 10) {
                message = 'ŞAHANE';
                messageClass = 'purple';
                imageUrl = 'https://cdn.pixabay.com/animation/2022/07/31/15/26/15-26-01-814_512.gif';
            } else if (score >= 8 && score <= 9) {
                message = 'Gayet İyi';
                messageClass = 'green';
                imageUrl = 'https://cdn.pixabay.com/photo/2016/04/01/00/28/face-1298202_1280.png';
            } else if (score >= 6 && score <= 7) {
                message = 'Daha iyisini yapabilirsin.';
                messageClass = 'green';
                imageUrl = 'https://cdn.pixabay.com/photo/2014/04/02/10/48/yellow-304649_1280.png';
            } else if (score >= 3 && score <= 5) {
                message = 'Kendini Geliştirmen Gerek.';
                messageClass = 'blue';
                imageUrl = 'https://cdn.pixabay.com/photo/2019/10/28/14/35/emoticon-4584554_960_720.png';
            } else {
                message = '';
                imageUrl = 'https://cdn.pixabay.com/photo/2020/09/14/18/33/sad-5571735_960_720.png';
            }

            scoreMessage.textContent = message;
            if (messageClass !== '') {
                scoreMessage.classList.add(messageClass);
            } else {
                scoreMessage.textContent = '';
            }

            scoreImage.src = imageUrl;
            scoreImage.style.display = 'block';
        }

        // Bu event listener, düello oyununun sonunda "Geri Dön" butonunu ortak seçim ekranındaki işlevle değiştirir.
        finalBackButton.addEventListener('click', async () => {
            if (currentDuelRef) {
                try {
                    await currentDuelRef.remove();
                    currentDuelRef = null;
                    isInviter = false;
                    duelGameStarted = false;
                    window.location.reload();
                } catch (error) {
                    console.error("Düello referansı kaldırılırken hata:", error);
                    showAlert('Düello referansı kaldırılırken hata oluştu.');
                }
            } else {
                window.location.reload();
            }
        });

        function resetTimer() {
            clearInterval(timer);
            timeLeft = 45;
            timerElement.textContent = timeLeft;
            timerElement.style.color = '#ff0000';
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    markQuestionAsWrong();
                    setTimeout(() => {
                        proceedToNextQuestion();
                    }, 1000);
                }
            }, 1000);
        }

        function markQuestionAsWrong() {
            document.querySelectorAll('.option-button').forEach(button => {
                if (button.dataset.correct === 'true') {
                    button.classList.add('correct');
                } else {
                    button.classList.add('wrong');
                }
                button.disabled = true;
            });
        }

        function fetchClassesForSelection() {
            database.ref('classes').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const classId = childSnapshot.key;
                        const classData = childSnapshot.val();
                        const className = classData.name ? classData.name : classId; // Sınıf adını alıyoruz

                        console.log(`Class ID: ${classId}, Class Name: ${className}`);

                        // Sınıf adı mevcut olduğu için doğrudan ekleyebiliriz
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = className;
                        selectionClassSelect.appendChild(option);
                    });
                } else {
                    console.warn("Seçim için sınıf yok.");
                }
            }).catch(error => {
                console.error("Seçim için sınıf çekme hata:", error);
            });
        }

        // Alert fonksiyonu
        const alertOverlay = document.getElementById('alertOverlay');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkButton = document.getElementById('alertOkButton');

        function showAlert(message) {
            alertMessage.textContent = message;
            alertOverlay.style.display = 'flex';
            return new Promise(resolve => {
                alertOkButton.onclick = () => {
                    alertOverlay.style.display = 'none';
                    resolve();
                };
            });
        }

        // Prompt fonksiyonu
        const promptOverlay = document.getElementById('promptOverlay');
        const promptMessage = document.getElementById('promptMessage');
        const promptInput = document.getElementById('promptInput');
        const promptCancelButton = document.getElementById('promptCancelButton');
        const promptOkButton = document.getElementById('promptOkButton');

        function showPrompt(message) {
            promptMessage.textContent = message;
            promptInput.value = '';
            promptOverlay.style.display = 'flex';

            return new Promise(resolve => {
                promptOkButton.onclick = () => {
                    const val = promptInput.value;
                    promptOverlay.style.display = 'none';
                    resolve(val);
                };

                promptCancelButton.onclick = () => {
                    promptOverlay.style.display = 'none';
                    resolve(null);
                };
            });
        }

        // Davet Etme ve Dinleme
        async function sendInvitation(player) {
            try {
                const inDuelSnapshot = await database.ref(`classes/${player.classId}/students/${player.studentId}/inDuel`).once('value');
                const isInDuel = inDuelSnapshot.exists() ? inDuelSnapshot.val() : false;

                if (isInDuel) {
                    showAlert(`${player.name} zaten bir düelloda!`);
                    return;
                }

                const invitationRef = database.ref(`invitations/${player.studentId}`);
                invitationRef.set({
                    invitedByName: selectedStudent.studentName,
                    invitedByClassId: selectedStudent.classId,
                    invitedByStudentId: selectedStudent.studentId,
                    invitedByPhoto: studentPhoto.src ? studentPhoto.src : ""
                }).then(() => {
                    showAlert(`${player.name} davet edildi!`);
                }).catch(error => {
                    console.error("Davet gönderme hatası:", error);
                    showAlert('Davet gönderilirken bir hata oluştu.');
                });
            } catch (error) {
                console.error("Düello kontrolü hata:", error);
                showAlert('Düello durumu kontrol edilirken hata oluştu.');
            }
        }

        function startInvitationListener(studentId) {
            database.ref(`invitations/${studentId}`).on('value', snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    currentInvitation = { ...data };
                    showInvitationModal(data);
                } else {
                    if (invitationOverlay.style.display === 'flex' && !currentInvitation) {
                        invitationOverlay.style.display = 'none';
                    }
                    currentInvitation = null;
                }
            });

            database.ref('duels').orderByChild('inviter/studentId').equalTo(studentId).on('child_added', snapshot => {
                if (currentDuelRef == null) {
                    currentDuelRef = snapshot.ref;
                    isInviter = true;
                    switchToDuelScreen(snapshot.key);
                }
            });

            database.ref('duels').orderByChild('invited/studentId').equalTo(studentId).on('child_added', snapshot => {
                if (currentDuelRef == null) {
                    currentDuelRef = snapshot.ref;
                    isInviter = false;
                    switchToDuelScreen(snapshot.key);
                }
            });
        }

        function showInvitationModal(data) {
            invitationMessage.textContent = `${data.invitedByName} (${classNameMap[data.invitedByClassId] ? classNameMap[data.invitedByClassId] : data.invitedByClassId}) seni düelloya davet ediyor.`;
            invitationOverlay.style.display = 'flex';
        }

        const invitationDeclineButton = document.getElementById('invitationDeclineButton');
        const invitationAcceptButton = document.getElementById('invitationAcceptButton');

        invitationDeclineButton.addEventListener('click', () => {
            if (currentInvitation && selectedStudent.studentId) {
                database.ref(`invitations/${selectedStudent.studentId}`).remove();
                invitationOverlay.style.display = 'none';
                currentInvitation = null;
            }
        });

        invitationAcceptButton.addEventListener('click', async () => {
            if (currentInvitation && selectedStudent.studentId) {
                try {
                    const inDuelSnap = await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).once('value');
                    const isInDuel = inDuelSnap.exists() ? inDuelSnap.val() : false;

                    if (isInDuel) {
                        showAlert(`Zaten bir düellodasın!`);
                        invitationOverlay.style.display = 'none';
                        currentInvitation = null;
                        return;
                    }

                    invitationOverlay.style.display = 'none';
                    await createDuelSession(currentInvitation.invitedByStudentId, currentInvitation.invitedByClassId, currentInvitation.invitedByName, currentInvitation.invitedByPhoto);
                    await database.ref(`invitations/${selectedStudent.studentId}`).remove();
                } catch (error) {
                    console.error("Düello başlatılırken hata:", error);
                    showAlert('Düello başlatılırken bir hata oluştu.');
                }
            }
        });

        async function createDuelSession(inviterId, inviterClassId, inviterName, inviterPhoto) {
            const duelRef = database.ref('duels').push();
            await duelRef.set({
                inviter: {
                    classId: inviterClassId,
                    studentId: inviterId,
                    name: inviterName,
                    photo: inviterPhoto
                },
                invited: {
                    classId: selectedStudent.classId,
                    studentId: selectedStudent.studentId,
                    name: selectedStudent.studentName,
                    photo: (studentPhoto.src && studentPhoto.src !== "") ? studentPhoto.src : ""
                },
                selections: {
                    class: "",
                    subject: "",
                    topic: ""
                },
                gameStarted: false
            });

            // Düello başladıktan sonra inDuel bayraklarını ayarla
            await database.ref(`classes/${inviterClassId}/students/${inviterId}/inDuel`).set(true);
            await database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/inDuel`).set(true);

            duelRef.onDisconnect().remove();

            currentDuelRef = duelRef;
            isInviter = false;
            switchToDuelScreen(duelRef.key);
        }

        function switchToDuelScreen(duelKey) {
            mainScreen.style.display = 'none';
            singlePlayerScreen.style.display = 'none';
            singlePlayerGameScreen.style.display = 'none';

            duelSelectionScreen.style.display = 'flex';

            database.ref('championData/headings').once('value').then(snapshot => {
                duelClassSelect.innerHTML = '<option value="">Seçiniz</option>';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const cid = childSnapshot.key;
                        const cname = childSnapshot.val().name ? childSnapshot.val().name : 'No name';
                        const option = document.createElement('option');
                        option.value = cid;
                        option.textContent = cname;
                        duelClassSelect.appendChild(option);
                    });
                }
            });

            currentDuelRef.on('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    duelInviterPhoto.src = data.inviter.photo ? data.inviter.photo : "https://via.placeholder.com/60";
                    duelInviterName.textContent = data.inviter.name;

                    duelInvitedPhoto.src = data.invited.photo ? data.invited.photo : "https://via.placeholder.com/60";
                    duelInvitedName.textContent = data.invited.name;

                    duelClassSelect.value = data.selections.class || "";
                    duelSubjectSelect.value = data.selections.subject || "";
                    duelTopicSelect.value = data.selections.topic || "";

                    if (data.gameStarted && !duelGameStarted) {
                        duelGameStarted = true; 
                        startDuelGame(data);
                    }

                    if (!isInviter) {
                        duelClassSelect.disabled = true;
                        duelSubjectSelect.disabled = true;
                        duelTopicSelect.disabled = true;
                        duelStartButton.disabled = true;
                    } else {
                        checkDuelSelections();
                    }
                }
            });
        }

        duelClassSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchLessons(duelClassSelect.value, duelSubjectSelect);
                updateDuelSelection('class', duelClassSelect.value);
            }
        });

        duelSubjectSelect.addEventListener('change', () => {
            if (isInviter) {
                fetchTopics(duelClassSelect.value, duelSubjectSelect.value, duelTopicSelect);
                updateDuelSelection('subject', duelSubjectSelect.value);
            }
        });

        duelTopicSelect.addEventListener('change', () => {
            if (isInviter) {
                updateDuelSelection('topic', duelTopicSelect.value);
            }
        });

        function updateDuelSelection(field, value) {
            currentDuelRef.child('selections').child(field).set(value);
            checkDuelSelections();
        }

        function checkDuelSelections() {
            if (isInviter) {
                const c = duelClassSelect.value;
                const s = duelSubjectSelect.value;
                const t = duelTopicSelect.value;
                if (c !== "" && s !== "" && t !== "") {
                    duelStartButton.classList.add('active');
                    duelStartButton.disabled = false;
                } else {
                    duelStartButton.classList.remove('active');
                    duelStartButton.disabled = true;
                }
            }
        }

        duelStartButton.addEventListener('click', async () => {
            duelClassId = duelClassSelect.value;
            duelSubjectId = duelSubjectSelect.value;
            duelTopicId = duelTopicSelect.value;

            const questionsRef = database.ref(`championData/headings/${duelClassId}/lessons/${duelSubjectId}/topics/${duelTopicId}/questions`);
            const snapshot = await questionsRef.once('value');
            if (snapshot.exists()) {
                const allQuestions = [];
                snapshot.forEach(cs => {
                    allQuestions.push(cs.val());
                });
                if (allQuestions.length < 10) {
                    showAlert('Bu konuya ait yeterli soru yok.');
                    return;
                }
                let chosen = shuffleArray(allQuestions).slice(0,10);
                chosen = chosen.map(q => {
                    let options = [
                        { text: q.correct, correct: true },
                        { text: q.wrong1, correct: false },
                        { text: q.wrong2, correct: false }
                    ];
                    let shuffled = shuffleArray(options);
                    return {
                        question: q.question,
                        options: shuffled
                    };
                });
                await currentDuelRef.child('questions').set(chosen);
                await currentDuelRef.child('gameStarted').set(true);
                showAlert("Düello Başlatıldı!");
            } else {
                showAlert("Bu konuya ait soru bulunamadı.");
            }
        });

        function startDuelGame(data) {
            // Düello başlarken final ekranı ve skorları resetleyelim
            duelFinalContainer.style.display='none';
            winnerMessage.textContent = '';

            duelSelectionScreen.style.display = 'none';
            duelGameScreen.style.display = 'flex';

            document.getElementById('duel-player-inviter-photo').src = data.inviter.photo ? data.inviter.photo : "https://via.placeholder.com/60";
            document.getElementById('duel-player-inviter-name').textContent = data.inviter.name;
            document.getElementById('duel-player-invited-photo').src = data.invited.photo ? data.invited.photo : "https://via.placeholder.com/60";
            document.getElementById('duel-player-invited-name').textContent = data.invited.name;

            duelInviterScore = 0;
            duelInvitedScore = 0;
            inviterCorrectCountEl.textContent = "0";
            invitedCorrectCountEl.textContent = "0";

            duelCurrentQuestionIndex = 0;
            if (data.questions) {
                duelQuestions = data.questions;
                loadDuelQuestion();
            }

            listenToResponses();

            // Düello oyunu başladığında arka plan müziğini çal
            duelMusic.currentTime = 0;
            duelMusic.play().catch(error => {
                console.error("Müzik çalınamadı:", error);
            });
            duelMusic.loop = true;
        }

        function loadDuelQuestion() {
            if (duelCurrentQuestionIndex >= 10) {
                endDuelGame();
                return;
            }
            duelQuestionLocked = false;
            const currentQuestion = duelQuestions[duelCurrentQuestionIndex];
            duelQuestionNumber.textContent = `Soru ${duelCurrentQuestionIndex + 1}/10`;
            const progressPercentage = ((duelCurrentQuestionIndex) / 10) * 100;
            duelProgressBarInner.style.width = `${progressPercentage}%`;

            if (currentQuestion.question.startsWith('http')) {
                duelQuestionImage.src = currentQuestion.question;
                duelQuestionImage.style.display = 'block';
                duelQuestionText.textContent = '';
            } else {
                duelQuestionImage.style.display = 'none';
                duelQuestionText.textContent = currentQuestion.question;
            }

            duelOptionsContainer.innerHTML = '';
            currentQuestion.options.forEach((option, idx) => {
                const button = document.createElement('button');
                button.classList.add('option-button');
                button.textContent = option.text;
                button.dataset.correct = option.correct;
                button.dataset.optionIndex = idx;
                button.addEventListener('click', duelSelectOption);
                duelOptionsContainer.appendChild(button);
            });

            resetDuelTimer();
            startDuelTimer();
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).remove();
        }

        function resetDuelTimer() {
            clearInterval(duelTimer);
            duelTimeLeft = 45;
            duelTimerElement.textContent = duelTimeLeft;
            duelTimerElement.style.color = '#ff0000';
        }

        function startDuelTimer() {
            duelTimer = setInterval(() => {
                duelTimeLeft--;
                duelTimerElement.textContent = duelTimeLeft;

                if (duelTimeLeft <= 0 && !duelQuestionLocked) {
                    clearInterval(duelTimer);
                    duelQuestionLocked = true;
                    revealDuelAnswerAfterTimeout();
                }
            }, 1000);
        }

        function duelSelectOption(e) {
            if (duelQuestionLocked) return;
            const selectedButton = e.target;
            const chosenOptionText = selectedButton.textContent;
            const isCorrect = selectedButton.dataset.correct === 'true';
            const playerId = selectedStudent.studentId;

            duelOptionsContainer.querySelectorAll('.option-button').forEach(b => {
                b.disabled = true;
                if (b !== selectedButton) {
                    b.classList.add('option-faded');
                } else {
                    b.classList.add('option-chosen');
                }
            });

            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).child(playerId).set({
                chosen: chosenOptionText,
                correct: isCorrect
            });
        }

        function listenToResponses() {
            currentDuelRef.child('responses').on('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    const currentAnswers = data[duelCurrentQuestionIndex] || {};
                    currentDuelRef.once('value', dsnap => {
                        const ddata = dsnap.val();
                        const invId = ddata.inviter.studentId;
                        const inId = ddata.invited.studentId;

                        const answeredCount = Object.keys(currentAnswers).length;
                        if (answeredCount === 2 && !duelQuestionLocked) {
                            duelQuestionLocked = true;
                            clearInterval(duelTimer);
                            revealDuelAnswerAfterTimeout();
                        }
                    });
                }
            });
        }

        // Yeni +1 Efekti Fonksiyonu
        function showScoreIncrementEffect(scoreElement) {
            const plusOne = document.createElement('div');
            plusOne.classList.add('animated-plus-one');
            plusOne.textContent = '+1';
            document.body.appendChild(plusOne);

            // Get center position
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // Get the scoreElement's position
            const rect = scoreElement.getBoundingClientRect();
            const targetX = rect.left + rect.width / 2;
            const targetY = rect.top + rect.height / 2;

            // Calculate translation
            const deltaX = targetX - centerX;
            const deltaY = targetY - centerY;

            // Animate
            plusOne.animate([
                { transform: `translate(-50%, -50%) translate(0px, 0px) scale(1)`, opacity: 1 },
                { transform: `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px) scale(0.5)`, opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });

            // Remove the element after animation
            setTimeout(() => {
                plusOne.remove();
            }, 1000);
        }

        function revealDuelAnswerAfterTimeout() {
            setTimeout(() => {
                revealDuelAnswer();
            }, 500);
        }

        function revealDuelAnswer() {
            currentDuelRef.child('responses').child(duelCurrentQuestionIndex).once('value').then(resSnap => {
                const responses = resSnap.val() || {};
                currentDuelRef.once('value').then(dSnap => {
                    const ddata = dSnap.val();
                    const invId = ddata.inviter.studentId;
                    const inId = ddata.invited.studentId;

                    const optionButtons = duelOptionsContainer.querySelectorAll('.option-button');
                    optionButtons.forEach(btn => {
                        if (btn.dataset.correct === 'true') {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('wrong');
                        }
                    });

                    let inviterOldScore = duelInviterScore;
                    let invitedOldScore = duelInvitedScore;

                    if (responses[invId] && responses[invId].correct) duelInviterScore++;
                    if (responses[inId] && responses[inId].correct) duelInvitedScore++;

                    if (duelInviterScore > inviterOldScore) {
                        inviterCorrectCountEl.textContent = duelInviterScore;
                        inviterCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(inviterCorrectCountEl);
                        setTimeout(()=>inviterCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    if (duelInvitedScore > invitedOldScore) {
                        invitedCorrectCountEl.textContent = duelInvitedScore;
                        invitedCorrectCountEl.classList.add('score-flash');
                        showScoreIncrementEffect(invitedCorrectCountEl);
                        setTimeout(()=>invitedCorrectCountEl.classList.remove('score-flash'),1000);
                    }

                    setTimeout(() => {
                        duelCurrentQuestionIndex++;
                        loadDuelQuestion();
                    }, 1500);
                });
            });
        }

        function endDuelGame() {
            currentDuelRef.off('value');
            currentDuelRef.child('responses').off('value');

            let message = '';
            let winnerId = null;
            let loserId = null;
            let classId = null;

            currentDuelRef.once('value').then(dSnap => {
                const ddata = dSnap.val();

                if (duelInviterScore > duelInvitedScore) {
                    message = `Kazanan: ${ddata.inviter.name}`;
                    winnerId = ddata.inviter.studentId;
                    loserId = ddata.invited.studentId;
                    classId = ddata.inviter.classId;
                } else if (duelInvitedScore > duelInviterScore) {
                    message = `Kazanan: ${ddata.invited.name}`;
                    winnerId = ddata.invited.studentId;
                    loserId = ddata.inviter.studentId;
                    classId = ddata.invited.classId;
                } else {
                    message = "Berabere Kaldınız!";
                }

                if (winnerId && loserId && classId) {
                    // Kazananın puanını +3, kaybedenin puanını -1 (en az 0)
                    const winnerRef = database.ref(`classes/${classId}/students/${winnerId}/gameCup`);
                    winnerRef.transaction(current => {
                        return (current || 0) + 3;
                    });

                    const loserRef = database.ref(`classes/${classId}/students/${loserId}/gameCup`);
                    loserRef.transaction(current => {
                        return Math.max((current || 0) - 1, 0);
                    });

                    // Refresh gameCup display for logged-in player if they are the winner or loser
                    if (winnerId === selectedStudent.studentId || loserId === selectedStudent.studentId) {
                        fetchAndDisplayGameCup();
                    }

                    // Set inDuel status to false for both players
                    database.ref(`classes/${classId}/students/${winnerId}/inDuel`).set(false).catch(error => {
                        console.error("inDuel durumu sıfırlanırken hata:", error);
                    });
                    database.ref(`classes/${classId}/students/${loserId}/inDuel`).set(false).catch(error => {
                        console.error("inDuel durumu sıfırlanırken hata:", error);
                    });
                }

                // Display winner message
                duelQuestionNumber.style.display = 'none';
                document.querySelector('#duel-game-screen .progress-container').style.display = 'none';
                document.querySelector('#duel-game-screen .timer-container').style.display = 'none';
                document.querySelector('#duel-game-screen .question-container').style.display = 'none';
                duelOptionsContainer.style.display = 'none';

                winnerMessage.textContent = message;
                duelFinalContainer.style.display = 'flex';

                // Kazanan ekranına geldiğinde arka plan müziğini durdur
                duelMusic.pause();
                duelMusic.currentTime = 0;
            });
        }

        // Artık `duel-final-back-button` için ayrı bir event listener yok.
        // `duel-final-back-button` artık yukarıda tanımlanan genel back-button işleviyle aynı işlevi görmektedir.

        function fetchAdminClasses() {
            database.ref('classes').once('value').then(snapshot => {
                if (snapshot.exists()) {
                    adminClassSelect.innerHTML = '<option value="">Seçiniz</option>';
                    snapshot.forEach(childSnapshot => {
                        const classId = childSnapshot.key;
                        const classData = childSnapshot.val();
                        const className = classData.name ? classData.name : classId; // Sınıf adını alıyoruz

                        console.log(`Admin Panel - Class ID: ${classId}, Class Name: ${className}`);

                        // Sınıf adı mevcut olduğu için doğrudan ekleyebiliriz
                        const option = document.createElement('option');
                        option.value = classId;
                        option.textContent = className;
                        adminClassSelect.appendChild(option);
                    });
                } else {
                    console.warn("Admin için sınıf bulunamadı.");
                }
            }).catch(error => {
                console.error("Admin sınıf çekme hata:", error);
            });

            adminClassSelect.addEventListener('change', () => {
                if (adminClassSelect.value !== "" && adminPinInput.value !== "") {
                    adminLoginButton.classList.add('active');
                    adminLoginButton.disabled = false;
                } else {
                    adminLoginButton.classList.remove('active');
                    adminLoginButton.disabled = true;
                }
            });
        }

        // Fetch and display gameCup for the logged-in student
        function fetchAndDisplayGameCup() {
            database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    document.getElementById('game-cup-score').textContent = snapshot.val();
                } else {
                    // Initialize gameCup to 0
                    database.ref(`classes/${selectedStudent.classId}/students/${selectedStudent.studentId}/gameCup`).set(0);
                    document.getElementById('game-cup-score').textContent = '0';
                }
            }).catch(error => {
                console.error("gameCup çekilirken hata:", error);
                document.getElementById('game-cup-score').textContent = '0';
            });
        }
    </script>
</body>
</html>
